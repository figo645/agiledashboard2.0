<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* 保持原有样式不变 */
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .chart {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sprint计划分析 -->
        <div class="chart-container">
            <div class="chart-title">Sprint计划分析</div>
            <div id="sprintPlanningChart" class="chart"></div>
        </div>

        <!-- 迭代完成进度 -->
        <div class="chart-container">
            <div class="chart-title">迭代完成进度</div>
            <div id="iterationCompletionChart" class="chart"></div>
        </div>

        <!-- 变更情况 -->
        <div class="chart-container">
            <div class="chart-title">变更情况</div>
            <div id="changeTrackingChart" class="chart"></div>
        </div>

        <!-- 测试进度 -->
        <div class="chart-container">
            <div class="chart-title">测试进度</div>
            <div id="testingProgressChart" class="chart"></div>
        </div>

        <!-- Bug处理进度 -->
        <div class="chart-container">
            <div class="chart-title">Bug处理进度</div>
            <div id="bugProgressChart" class="chart"></div>
        </div>
    </div>

    <script>
        // 初始化所有图表
        const sprintPlanningChart = echarts.init(document.getElementById('sprintPlanningChart'));
        const iterationCompletionChart = echarts.init(document.getElementById('iterationCompletionChart'));
        const changeTrackingChart = echarts.init(document.getElementById('changeTrackingChart'));
        const testingProgressChart = echarts.init(document.getElementById('testingProgressChart'));
        const bugProgressChart = echarts.init(document.getElementById('bugProgressChart'));

        // 从后端API获取数据并更新图表
        async function fetchDataAndUpdateCharts() {
            try {
                // 获取Sprint计划数据
                const sprintPlanningResponse = await axios.get('/api/sprint_planning');
                updateSprintPlanningChart(sprintPlanningResponse.data);

                // 获取迭代完成数据
                const iterationCompletionResponse = await axios.get('/api/iteration_completion');
                updateIterationCompletionChart(iterationCompletionResponse.data);

                // 获取变更跟踪数据
                const changeTrackingResponse = await axios.get('/api/change_tracking');
                updateChangeTrackingChart(changeTrackingResponse.data);

                // 获取测试进度数据
                const testingProgressResponse = await axios.get('/api/testing_progress');
                updateTestingProgressChart(testingProgressResponse.data);

                // 获取Bug进度数据
                const bugProgressResponse = await axios.get('/api/bug_progress');
                updateBugProgressChart(bugProgressResponse.data);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // 更新Sprint计划图表
        function updateSprintPlanningChart(data) {
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['团队规模', '总点数', '人均点数']
                },
                xAxis: {
                    type: 'category',
                    data: data.teams.map(team => team.teamName)
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '数量',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: '百分比',
                        position: 'right',
                        max: 100,
                        min: 0
                    }
                ],
                series: [
                    {
                        name: '团队规模',
                        type: 'bar',
                        data: data.teams.map(team => team.teamSize)
                    },
                    {
                        name: '总点数',
                        type: 'bar',
                        data: data.teams.map(team => team.totalPoints)
                    },
                    {
                        name: '人均点数',
                        type: 'bar',
                        data: data.teams.map(team => team.pointsPerPerson)
                    }
                ]
            };
            sprintPlanningChart.setOption(option);
        }

        // 更新迭代完成图表
        function updateIterationCompletionChart(data) {
            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['计划进度', '实际进度', ...data.teams.map(team => team.teamName)]
                },
                xAxis: {
                    type: 'category',
                    data: data.labels
                },
                yAxis: {
                    type: 'value',
                    name: '完成率(%)',
                    max: 100,
                    min: 0
                },
                series: [
                    {
                        name: '计划进度',
                        type: 'line',
                        data: data.planned
                    },
                    {
                        name: '实际进度',
                        type: 'line',
                        data: data.actual
                    },
                    ...data.teams.map(team => ({
                        name: team.teamName,
                        type: 'line',
                        data: team.actual
                    }))
                ]
            };
            iterationCompletionChart.setOption(option);
        }

        // 更新变更跟踪图表
        function updateChangeTrackingChart(data) {
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['新增任务', '修改任务', '删除任务']
                },
                xAxis: {
                    type: 'category',
                    data: data.labels
                },
                yAxis: {
                    type: 'value',
                    name: '任务数'
                },
                series: [
                    {
                        name: '新增任务',
                        type: 'bar',
                        data: data.newTasks
                    },
                    {
                        name: '修改任务',
                        type: 'bar',
                        data: data.modifiedTasks
                    },
                    {
                        name: '删除任务',
                        type: 'bar',
                        data: data.removedTasks
                    }
                ]
            };
            changeTrackingChart.setOption(option);
        }

        // 更新测试进度图表
        function updateTestingProgressChart(data) {
            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['计划测试', '实际测试', ...data.teams.map(team => team.teamName)]
                },
                xAxis: {
                    type: 'category',
                    data: data.labels
                },
                yAxis: {
                    type: 'value',
                    name: '完成率(%)',
                    max: 100,
                    min: 0
                },
                series: [
                    {
                        name: '计划测试',
                        type: 'line',
                        data: data.plannedTesting
                    },
                    {
                        name: '实际测试',
                        type: 'line',
                        data: data.actualTesting
                    },
                    ...data.teams.map(team => ({
                        name: team.teamName,
                        type: 'line',
                        data: team.actualTesting
                    }))
                ]
            };
            testingProgressChart.setOption(option);
        }

        // 更新Bug进度图表
        function updateBugProgressChart(data) {
            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['新增Bug', '修复Bug', '剩余Bug']
                },
                xAxis: {
                    type: 'category',
                    data: data.labels
                },
                yAxis: {
                    type: 'value',
                    name: 'Bug数量'
                },
                series: [
                    {
                        name: '新增Bug',
                        type: 'line',
                        data: data.newBugs
                    },
                    {
                        name: '修复Bug',
                        type: 'line',
                        data: data.fixedBugs
                    },
                    {
                        name: '剩余Bug',
                        type: 'line',
                        data: data.remainingBugs
                    }
                ]
            };
            bugProgressChart.setOption(option);
        }

        // 页面加载完成后获取数据
        window.addEventListener('load', fetchDataAndUpdateCharts);

        // 窗口大小改变时重新调整图表大小
        window.addEventListener('resize', function() {
            sprintPlanningChart.resize();
            iterationCompletionChart.resize();
            changeTrackingChart.resize();
            testingProgressChart.resize();
            bugProgressChart.resize();
        });
    </script>
</body>
</html> 